angular.module("FredrikSandell.worker-pool",[]).service("WorkerService",["$q",function(a){function b(a){var b="";return angular.forEach(a,function(a){j[a]&&(b+="importScripts('"+j[a].url+"');")}),b}function c(a){var b=[];return angular.forEach(a,function(a){j[a]&&b.push("'"+j[a].moduleName+"'")}),b.join(",")}function d(a){var d=a.filter(function(a){return"input"!==a&&"output"!==a&&"$q"!==a}),e={dependencies:d,moduleList:c(d),angularDepsAsStrings:d.length>0?","+d.map(function(a){return"'"+a+"'"}).join(","):"",angularDepsAsParamList:d.length>0?","+d.join(","):"",servicesIncludeStatements:b(d)};return e.workerFuncParamList="input,output"+e.angularDepsAsParamList,e}function e(a,b){return k.replace("<URL_TO_ANGULAR>",h).replace("<CUSTOM_DEP_INCLUDES>",b.servicesIncludeStatements).replace("<DEP_MODULES>",b.moduleList).replace("<STRING_DEP_NAMES>",b.angularDepsAsStrings).replace("<DEP_NAMES>",b.angularDepsAsParamList).replace("<WORKER_FUNCTION>",a.toString())}function f(a){return a.slice(0,a.length-1)}function g(a,b){return"("+a.toString()+")("+b+")"}var h,i={},j={},k=["","var window = self;","self.history = {};","self.Node = function () {};","var document = {","      readyState: 'complete',","      cookie: '',","      querySelector: function () {},","      createElement: function () {","          return {","              pathname: '',","              setAttribute: function () {}","          };","      }","};","importScripts('<URL_TO_ANGULAR>');","<CUSTOM_DEP_INCLUDES>","angular = window.angular;","var workerApp = angular.module('WorkerApp', [<DEP_MODULES>]);","workerApp.run(['$q'<STRING_DEP_NAMES>, function ($q<DEP_NAMES>) {","  self.addEventListener('message', function(e) {","    var input = e.data;","    var output = $q.defer();","    var promise = output.promise;","    promise.then(function(success) {","      self.postMessage({event:'success', data : success});","    }, function(reason) {","      self.postMessage({event:'failure', data : reason});","    }, function(update) {","      self.postMessage({event:'update', data : update});","    });","    <WORKER_FUNCTION>;","  });","  self.postMessage({event:'initDone'});","}]);","angular.bootstrap(null, ['WorkerApp']);"].join("\n");i.setAngularUrl=function(a){return h=a,i},i.addDependency=function(a,b,c){return j[a]={url:c,moduleName:b},i},i.createAngularWorker=function(b){if(!Array.isArray(b)||b.length<3||"function"!=typeof b[b.length-1])throw new Error("Input needs to be: ['input','output'/*optional additional dependencies*/,\n    function(workerInput, deferredOutput /*optional additional dependencies*/)\n        {/*worker body*/}]");if("string"!=typeof h)throw new Error("The url to angular must be defined before worker creation");var c=a.defer(),i=d(f(b)),j=(window.URL?URL:webkitURL).createObjectURL(new Blob([e(g(b[b.length-1],i.workerFuncParamList),i)],{type:"application/javascript"})),k=new Worker(j);return k.addEventListener("message",function(a){var b=a.data.event;"initDone"===b?c.resolve(l(k)):c.reject(a)}),c.promise};var l=function(b){var c={};return c.worker=b,c.run=function(c){var d=a.defer();return b.addEventListener("message",function(a){var b=a.data.event;if("initDone"===b)throw new Error("Received worker initialization in run method. This should already have occurred!");"success"===b?d.resolve(a.data.data):"failure"===b?d.reject(a.data.data):"update"===b?d.notify(a.data.data):d.reject(a)}),b.postMessage(c),d.promise},c.terminate=function(){b.terminate()},c};return i}]);